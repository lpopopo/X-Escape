# X-Escape 游戏流程详解

## 游戏背景
玩家扮演一家劫匪，在犯下罪行后驾车逃往边境。在10天的逃亡旅程中，需要管理车内人员的饱腹度和伪装度，合理分配资源，确保至少有一个角色存活到第10天。

## 完整游戏流程

### 第1天：游戏开始

#### 初始状态
- 所有角色状态满档
  - 饱腹度: 100（5档）
  - 伪装度: 100（5档）
- 初始物品库存（根据游戏设定）
- 车辆油量充足

#### 玩家操作
1. **进入车内场景（CarScene）**
   - 查看所有角色的当前状态
   - 了解物品库存情况

2. **视角切换（可选）**
   - 默认视角：车内视角（Interior View）
   - 可切换到：车前窗视角（Front Window View）
   - 操作方式：点击视角切换按钮

3. **分配物品**
   - 从库存中拖动物品到角色身上
   - 食物物品：补充饱腹度
   - 伪装物品：补充伪装度
   - 每个角色可携带1个食物 + 1个伪装

4. **准备出发**
   - 确认所有角色的物品分配
   - 点击"出发"按钮
   - 触发天数推进

### 天数推进与物品结算

#### 结算流程
当玩家点击"出发"按钮时，系统自动执行以下步骤：

```
1. 暂停交互（防止重复点击）
2. 显示天数标题（例如："第2天"）
3. 执行物品结算
   ├─ 遍历所有角色
   ├─ 检查是否持有食物
   │  ├─ 有食物 → 消耗物品，饱腹度恢复到100（5档）
   │  └─ 无食物 → 饱腹度降低20（下降1档）
   ├─ 检查是否持有伪装
   │  ├─ 有伪装 → 消耗物品，伪装度恢复到100（5档）
   │  └─ 无伪装 → 伪装度降低20（下降1档）
   └─ 检查角色死亡条件
      └─ 连续2天饱腹度为0 → 角色死亡
4. 清空所有物品实例
5. 切换到逃亡场景（EscapeScene）
```

#### 结算规则详解

**饱腹度结算**:
- 持有食物：消耗物品，饱腹度 = 100（恢复到5档）
- 无食物：饱腹度 - 20（下降1档）
- 特殊情况：如果当前饱腹度已经是0，且上一天也是0，则角色死亡

**伪装度结算**:
- 持有伪装：消耗物品，伪装度 = 100（恢复到5档）
- 无伪装：伪装度 - 20（下降1档）
- 伪装度最低为0，不会导致角色死亡

**示例**:
```
角色A（第1天结束时）:
- 持有食物：是
- 持有伪装：否
- 当前饱腹度：100
- 当前伪装度：100

结算后（第2天开始时）:
- 饱腹度：100（食物被消耗）
- 伪装度：80（降低20，从5档降到4档）
```

### 逃亡场景（第2-10天循环）

#### 进入逃亡场景
结算完成后，自动切换到逃亡场景（EscapeScene）

#### 地图系统
1. **地图节点类型**
   - 城镇节点（Town）：可以搜寻物资
   - 边境节点（Border）：游戏目标

2. **节点可见性**
   - 初始只显示部分节点
   - 随着玩家推进，更多节点解锁

3. **移动机制**
   - 点击可到达的节点
   - 消耗油量（根据距离）
   - 到达节点触发相应事件

#### 城镇搜寻
1. **选择城镇节点**
   - 点击地图上的城镇图标
   - 显示城镇信息

2. **进入搜寻**
   - 选择"搜寻物资"选项
   - 切换到拾取场景（PickupScene）

### 拾取场景（PickupScene）

#### 场景介绍
玩家控制角色在限定时间内拾取掉落的物品

#### 玩家操作
1. **角色移动**
   - A键：向左移动
   - D键：向右移动
   - 角色在地面上左右移动

2. **拾取物品**
   - 物品从上方随机掉落
   - 角色碰到物品自动拾取
   - 拾取后物品加入库存

3. **物品类型**
   - 食物（FoodItem）：红色/绿色图标
   - 伪装物品（DisguiseItem）：蓝色/黄色图标
   - 随机生成，概率可配置

4. **时间限制**
   - 固定时间内拾取（例如：30秒）
   - 时间结束自动返回车内场景

5. **返回车内**
   - 拾取结束后，回到车内场景
   - 库存更新，显示新拾取的物品

### 回到车内场景

#### 新的一天开始
1. **查看角色状态**
   - 查看结算后的饱腹度和伪装度
   - 识别需要优先分配物品的角色

2. **查看库存**
   - 查看剩余物品数量
   - 查看刚拾取的新物品

3. **制定策略**
   - 优先给饱腹度低的角色分配食物
   - 优先给伪装度低的角色分配伪装
   - 权衡物品使用，规划未来天数

4. **重复流程**
   - 分配物品
   - 点击"出发"
   - 结算 → 逃亡 → 搜寻 → 拾取 → 车内
   - 循环直到第10天

### 游戏结局（第10天）

#### 胜利条件
- 第10天结束时，至少有1个角色存活
- 触发胜利画面（Victory）
- 显示存活角色数量和最终状态

#### 失败条件
- 第10天结束前，所有角色死亡
- 触发游戏结束画面（GameOver）
- 显示存活天数和失败原因

## 核心策略要点

### 1. 资源分配策略

#### 优先级系统
```
高优先级（紧急）:
- 饱腹度 ≤ 20（1-2档）→ 必须分配食物
- 连续1天饱腹度为0 → 极度紧急，下一天必须分配食物

中优先级（警告）:
- 饱腹度 25-49（3档）→ 建议分配食物
- 伪装度 ≤ 20（1-2档）→ 建议分配伪装

低优先级（正常）:
- 饱腹度 ≥ 50（4-5档）→ 暂时安全
- 伪装度 ≥ 50（4-5档）→ 暂时安全
```

#### 物品储备建议
- 前3天：适度使用物品，确保角色健康
- 中期（4-7天）：控制物品消耗，增加储备
- 后期（8-10天）：优先保证角色存活

### 2. 搜寻策略

#### 城镇选择
- 优先搜寻物品丰富的城镇
- 考虑油量消耗和距离
- 规划最优路线

#### 拾取技巧
- 专注于高价值物品（食物优先）
- 左右移动保持灵活
- 注意物品掉落速度和位置

### 3. 角色管理

#### 状态监控
- 实时查看角色悬停提示（OccupantHoverTooltip）
- 显示当前档位和精确数值
- 识别危险状态（红色警告）

#### 死亡预防
- 避免任何角色连续2天饱腹度为0
- 合理分配物品，确保轮换使用
- 必要时牺牲部分角色以保证其他人存活

## 特殊机制说明

### 视角切换系统
1. **车内视角（Interior View）**
   - 查看所有角色和物品
   - 进行物品分配操作
   - 主要游戏视角

2. **车前窗视角（Front Window View）**
   - 查看车外环境
   - 沉浸式体验
   - 无法进行物品操作

3. **切换操作**
   - 点击"切换视角"按钮
   - 相机平滑过渡（1秒）
   - 可随时切换

### 物品系统细节

#### 物品赋予流程
```
1. 鼠标按下库存物品（StockItem）
2. 开始拖动
3. 移动到角色的物品放置区域（ItemDropZone）
4. 鼠标释放
   ├─ 区域内释放 → 物品赋予成功
   │  ├─ 生成物品实例（Prefab）
   │  ├─ 更新数据管理器状态
   │  ├─ 库存数量 -1
   │  └─ 显示取消按钮
   └─ 区域外释放 → 物品返回库存
```

#### 物品取消流程
```
1. 点击角色身上的"X"按钮（ItemCancelButton）
2. 确认取消操作
   ├─ 销毁物品实例
   ├─ 更新数据管理器状态
   ├─ 库存数量 +1
   └─ 隐藏取消按钮
```

#### 物品双重追踪
系统采用双重追踪机制确保数据一致性：
1. **GameObject追踪**（ItemInstanceManager）
   - 追踪场景中的物品GameObject实例
   - 用于视觉显示和清理

2. **数据追踪**（CharacterItemDataManager）
   - 追踪角色是否持有物品的布尔状态
   - 用于结算时的逻辑判断

### 角色死亡机制

#### 死亡条件
```
if (饱腹度 == 0 && 上次饱腹度 == 0) {
    角色死亡
}
```

#### 死亡效果
- 角色GameObject设置为inactive
- 物品放置区域禁用
- 该角色不再参与后续游戏
- 不再消耗资源

#### 全灭判定
```
if (所有角色都死亡) {
    游戏结束（GameOver）
}
```

## 游戏时间线示例

### 示例：10天完整流程

```
【第1天】
车内: 初始状态，所有角色满档（饱腹100，伪装100）
分配: 不分配物品（因为状态良好）
出发: 点击出发
结算: 所有角色饱腹-20，伪装-20（变为4档）
逃亡: 前往城镇A
拾取: 获得2个食物，1个伪装

【第2天】
车内: 所有角色4档（饱腹80，伪装80）
分配: 不分配物品（状态仍然良好）
出发: 点击出发
结算: 所有角色饱腹-20，伪装-20（变为3档）
逃亡: 前往城镇B
拾取: 获得1个食物，2个伪装

【第3天】
车内: 所有角色3档（饱腹60，伪装60）
分配: 给角色A分配1个食物（预防下降）
出发: 点击出发
结算: 角色A饱腹恢复100，其他角色-20
逃亡: 前往城镇C
拾取: 获得3个食物，1个伪装

【第4-9天】
持续循环: 搜寻 → 分配 → 结算
策略: 优先保证饱腹度，适当牺牲伪装度
风险: 如果拾取不足，可能需要让部分角色死亡

【第10天】
车内: 检查所有角色状态
分配: 使用剩余物品，确保存活
出发: 点击出发
结算: 最后一次结算
结局: 如果有角色存活 → 胜利！
```

## 高级技巧

### 1. 轮换策略
不要让所有角色同时消耗物品，而是轮流补充：
```
第1天: 不分配
第2天: 给角色A、B分配
第3天: 给角色C、D分配
第4天: 给角色A、B分配
...以此类推
```

### 2. 牺牲策略
如果资源不足，可以选择性放弃某些角色：
```
优先保护: 状态最好的角色
放弃: 状态最差或连续1天饱腹为0的角色
```

### 3. 拾取优先级
在拾取场景中：
```
最高优先级: 食物（维持生命）
次要优先级: 伪装（影响游戏难度，但不致命）
```

### 4. 风险评估
每天评估风险：
```
低风险: 所有角色 ≥ 3档，库存充足
中风险: 部分角色2档，库存紧张
高风险: 角色1档或连续1天为0，库存不足
```

## 常见问题

### Q1: 如何判断角色需要物品？
**A**: 查看角色状态档位和数值：
- 饱腹度 ≤ 20（1-2档）：紧急需要食物
- 饱腹度 25-49（3档）：建议分配食物
- 伪装度类似，但不影响生存

### Q2: 物品不够怎么办？
**A**: 采取以下策略：
1. 优先保证饱腹度（伪装度可以牺牲）
2. 集中资源保护部分角色
3. 增加搜寻频率，多去城镇拾取

### Q3: 角色会自动使用物品吗？
**A**: 不会。只有在点击"出发"进行结算时，物品才会被消耗。玩家需要主动分配物品。

### Q4: 可以在逃亡场景分配物品吗？
**A**: 不可以。物品分配只能在车内场景进行。

### Q5: 伪装度有什么用？
**A**: 当前版本中伪装度主要影响游戏难度（可能在未来版本中影响警察检查事件）。但伪装度为0不会导致角色死亡。

### Q6: 如何预览角色状态？
**A**: 将鼠标悬停在角色上，会显示OccupantHoverTooltip，包含：
- 角色名称
- 饱腹度档位和数值
- 伪装度档位和数值
- 持有物品信息

---

**文档版本**: 1.0
**更新日期**: 2026-01-25
**适用游戏版本**: 第一阶段开发完成版本
